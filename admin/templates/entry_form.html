{% extends "base.html" %} {% block title %}{{ mode }} Entry{% endblock %} {%
block content %}
<h3>{{ mode }} Knowledge Base Entry</h3>

<form id="entryForm" class="mt-3" enctype="multipart/form-data">
  <div class="card mb-3">
  <div class="card-header">Target Dataset</div>
  <div class="card-body row g-3">

    <div class="col-md-4">
      <label class="form-label">Semester</label>
      <input
        type="number"
        name="semester"
        class="form-control"
        min="1"
        max="8"
        required
        value="{{ entry._semester if entry else '' }}"
        {% if mode == "Update" %}readonly{% endif %}
      />
    </div>

    <div class="col-md-4">
      <label class="form-label">Subject</label>
      <select
        name="subject"
        class="form-select"
        required
        {% if mode == "Update" %}disabled{% endif %}
      >
        <option value="">Select subject</option>
        {% for code, name in subjects.items() %}
          <option value="{{ code }}" {% if entry and entry._subject == code %}selected{% endif %}>
            {{ code }} â€” {{ name }}
          </option>
        {% endfor %}
      </select>

      {% if mode == "Update" %}
        <input type="hidden" name="subject" value="{{ entry._subject }}">
      {% endif %}
    </div>

    <div class="col-md-4">
      <label class="form-label">Module</label>
      <input
        type="number"
        name="module"
        class="form-control"
        min="0"
        required
        value="{{ entry._module if entry else '' }}"
        {% if mode == "Update" %}readonly{% endif %}
      />
    </div>

  </div>
</div>


  <div class="mb-3">
    <label class="form-label">Question</label>
    <textarea class="form-control" name="question" rows="2" required>{{ entry.question if entry else '' }}</textarea>
  </div>

  <div class="mb-3">
    <label class="form-label">Answer</label>
    <textarea class="form-control" name="answer" rows="4" required>{{ entry.answer if entry else '' }}</textarea>
  </div>

  <div class="mb-3">
    <label class="form-label">Tags (comma-separated)</label>
    <input
      class="form-control"
      name="tags"
      value="{{ entry.tags | join(',') if entry }}"
      id="tags-textarea"
    />
    <div id="tags-editor" class="tags-editor">
  <!-- tag chips injected here -->
  <div id="add-tag-chip" class="tag-chip tag-add">+</div>
</div>

  </div>

  <div class="mb-3">
    <label class="form-label">Notes</label>
    <textarea class="form-control" name="notes" rows="2">{{ entry.notes if entry else '' }}</textarea>
  </div>

  <div class="mb-3">
    <label class="form-label">Source File (optional)</label>
    <input type="file" class="form-control" name="file" />
  </div>

  <button class="btn btn-primary" type="submit">Submit</button>
  <a href="/" class="btn btn-secondary">Cancel</a>
</form>

<script>
  document.getElementById("entryForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target);

    const res = await fetch("{{ submit_url }}", {
      method: "{{ method }}",
      body: formData,
    });

    if (res.ok) {
      alert("Entry saved successfully");

      if (window.opener) {
        window.opener.location.reload();
        window.close();
      } else {
        window.location.href = "/";
      }
    }
  });

  let tags = [];

  function normalizeTags(raw) {
  return raw
    .split(",")
    .map(t => t.trim())
    .filter(Boolean);
}

function resizeInput(input) {
  input.style.width = "1ch";
  input.style.width = input.value.length + 1 + "ch";
}


function renderTagChips() {
  const editor = document.getElementById("tags-editor");
  editor.querySelectorAll(".tag-chip:not(.tag-add)").forEach(e => e.remove());

  tags.forEach((tag, index) => {
    const chip = document.createElement("div");
    chip.className = "tag-chip";

    const input = document.createElement("input");
    input.value = tag;

    resizeInput(input);

    input.addEventListener("focus", () => {
      resizeInput(input);
    });

    input.addEventListener("input", () => {
      tags[index] = input.value.trim();
      resizeInput(input);
      syncTextarea();
    });

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();

        // Commit current value
        tags[index] = input.value.trim();

        // Add new empty tag
        tags.splice(index + 1, 0, "");
        syncAll();

        // Focus newly created chip
        setTimeout(() => {
          const inputs = document.querySelectorAll(".tag-chip input");
          inputs[index + 1]?.focus();
        }, 0);
      }
    });

    input.addEventListener("blur", () => {
      if (!input.value.trim()) {
        chip.classList.add("removing");
        setTimeout(() => {
          tags.splice(index, 1);
          syncAll();
        }, 1200);
      }
    });

    chip.appendChild(input);
    editor.insertBefore(chip, document.getElementById("add-tag-chip"));
  });
}

function syncFromTextarea() {
  const textarea = document.getElementById("tags-textarea");
  tags = normalizeTags(textarea.value);
  renderTagChips();
}

function syncTextarea() {
  document.getElementById("tags-textarea").value = tags.join(", ");
}

function syncAll() {
  syncTextarea();
  renderTagChips();
}

document.getElementById("add-tag-chip").addEventListener("click", () => {
  tags.push("");
  renderTagChips();

  // Focus the new chip
  const inputs = document.querySelectorAll(".tag-chip input");
  inputs[inputs.length - 1]?.focus();
});

document.addEventListener("DOMContentLoaded", () => {
  const textarea = document.getElementById("tags-textarea");
  tags = normalizeTags(textarea.value);
  renderTagChips();

  textarea.addEventListener("input", syncFromTextarea);
});

</script>
{% endblock %}
